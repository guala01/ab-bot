<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Teams - <%= day %>
    </title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #121212;
            color: #e0e0e0;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #888;
            text-decoration: none;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: #fff;
        }

        h1 {
            color: #fff;
            margin: 0 0 5px 0;
            font-weight: 600;
        }

        .meta {
            color: #555;
            font-size: 0.85em;
            margin-bottom: 25px;
        }

        .slot-section {
            margin-bottom: 25px;
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
        }

        .slot-title {
            background: #333;
            color: #fff;
            padding: 6px 14px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 0;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }

        .slot-title:hover {
            background: #3a3a3a;
        }

        .slot-title .arrow {
            transition: transform 0.2s;
            font-size: 0.8em;
        }

        /* Hide slots until JS applies state */
        .slot-section {
            opacity: 0;
            transition: opacity 0.1s;
        }

        body.ready .slot-section {
            opacity: 1;
        }

        .slot-section.expanded .slot-title {
            margin-bottom: 15px;
        }

        .slot-section.expanded .slot-title .arrow {
            transform: rotate(90deg);
        }

        .teams-container {
            display: none;
            gap: 12px;
        }

        .slot-section.expanded .teams-container {
            display: flex;
        }

        .team-col {
            flex: 1;
            background: #252525;
            padding: 12px;
            border-radius: 6px;
            min-height: 120px;
            border: 1px solid #333;
        }

        .team-header {
            font-weight: 600;
            text-align: center;
            margin-bottom: 12px;
            font-size: 0.95em;
            color: #aaa;
        }

        .player-card {
            background: #1e1e1e;
            padding: 10px 12px;
            margin-bottom: 8px;
            border: 1px solid #333;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: border-color 0.2s;
        }

        .player-card:hover {
            border-color: #555;
        }

        .player-name {
            font-weight: 500;
        }

        .player-username {
            font-size: 0.8em;
            color: #555;
        }

        .actions {
            display: flex;
            gap: 4px;
        }

        .actions button {
            font-size: 0.75em;
            padding: 4px 8px;
            cursor: pointer;
            border: none;
            border-radius: 3px;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        .btn-a {
            background: #ffa726;
            color: #121212;
        }

        .btn-b {
            background: #66bb6a;
            color: #121212;
        }

        .btn-u {
            background: #555;
            color: #fff;
        }

        .actions button:hover {
            opacity: 0.8;
        }

        .empty-slot {
            color: #555;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="/dashboard" class="back-link">‚Üê Back to Dashboard</a>
        <h1>Manage Teams: <%= day %>
        </h1>
        <div class="meta">Message ID: <%= messageId %>
        </div>

        <% const times=Object.keys(slots).sort(); %>
            <% if (times.length===0) { %>
                <div class="empty-slot">No signups for this day.</div>
                <% } %>

                    <% times.forEach(function(time) { %>
                        <% const total=slots[time].length; const countA=slots[time].filter(s=> s.team === 'A').length;
                            const countB = slots[time].filter(s => s.team === 'B').length;
                            const countU = total - countA - countB;
                            %>
                            <div class="slot-section" id="slot-<%= time.replace(':', '-') %>">
                                <div class="slot-title" onclick="toggleSlot('<%= time.replace(':', '-') %>')">
                                    <span class="arrow">‚ñ∂</span>
                                    üïê <%= time %> <span style="opacity:0.7;">(<%= total %>)</span>
                                </div>
                                <div class="teams-container">
                                    <!-- Unassigned -->
                                    <div class="team-col">
                                        <div class="team-header">Unassigned (<%= countU %>)</div>
                                        <% let hasUnassigned=false; %>
                                            <% slots[time].forEach(function(s) { if (!s.team) { hasUnassigned=true; %>
                                                <div class="player-card">
                                                    <div>
                                                        <div class="player-name">
                                                            <%= s.customName || s.user_display_name %>
                                                        </div>
                                                        <div class="player-username">
                                                            <%= s.username %>
                                                        </div>
                                                    </div>
                                                    <div class="actions">
                                                        <button class="btn-a"
                                                            onclick="setTeam('<%= s.user_id %>', '<%= time %>', 'A')">A</button>
                                                        <button class="btn-b"
                                                            onclick="setTeam('<%= s.user_id %>', '<%= time %>', 'B')">B</button>
                                                    </div>
                                                </div>
                                                <% } }); %>
                                                    <% if (!hasUnassigned) { %>
                                                        <div class="empty-slot">‚Äî</div>
                                                        <% } %>
                                    </div>

                                    <!-- Team A -->
                                    <div class="team-col">
                                        <div class="team-header" style="color:#ffa726;">Team A (<%= countA %>)</div>
                                        <% let hasA=false; %>
                                            <% slots[time].forEach(function(s) { if (s.team==='A' ) { hasA=true; %>
                                                <div class="player-card">
                                                    <div class="player-name">
                                                        <%= s.customName || s.user_display_name %>
                                                    </div>
                                                    <div class="actions">
                                                        <button class="btn-u"
                                                            onclick="setTeam('<%= s.user_id %>', '<%= time %>', null)">‚úï</button>
                                                        <button class="btn-b"
                                                            onclick="setTeam('<%= s.user_id %>', '<%= time %>', 'B')">‚ÜíB</button>
                                                    </div>
                                                </div>
                                                <% } }); %>
                                                    <% if (!hasA) { %>
                                                        <div class="empty-slot">‚Äî</div>
                                                        <% } %>
                                    </div>

                                    <!-- Team B -->
                                    <div class="team-col">
                                        <div class="team-header" style="color:#66bb6a;">Team B (<%= countB %>)</div>
                                        <% let hasB=false; %>
                                            <% slots[time].forEach(function(s) { if (s.team==='B' ) { hasB=true; %>
                                                <div class="player-card">
                                                    <div class="player-name">
                                                        <%= s.customName || s.user_display_name %>
                                                    </div>
                                                    <div class="actions">
                                                        <button class="btn-u"
                                                            onclick="setTeam('<%= s.user_id %>', '<%= time %>', null)">‚úï</button>
                                                        <button class="btn-a"
                                                            onclick="setTeam('<%= s.user_id %>', '<%= time %>', 'A')">‚ÜíA</button>
                                                    </div>
                                                </div>
                                                <% } }); %>
                                                    <% if (!hasB) { %>
                                                        <div class="empty-slot">‚Äî</div>
                                                        <% } %>
                                    </div>
                                </div>
                            </div>
                            <% }); %>
    </div>

    <script>
        const messageId = '<%= messageId %>';

        // Restore expanded slots from sessionStorage
        document.addEventListener('DOMContentLoaded', () => {
            const expandedSlots = JSON.parse(sessionStorage.getItem('expandedSlots_' + messageId) || '[]');
            expandedSlots.forEach(slotId => {
                const section = document.getElementById('slot-' + slotId);
                if (section) section.classList.add('expanded');
            });
            // Show slots after state is restored
            document.body.classList.add('ready');
        });

        function saveExpandedState() {
            const expanded = [];
            document.querySelectorAll('.slot-section.expanded').forEach(el => {
                expanded.push(el.id.replace('slot-', ''));
            });
            sessionStorage.setItem('expandedSlots_' + messageId, JSON.stringify(expanded));
        }

        function toggleSlot(slotId) {
            const section = document.getElementById('slot-' + slotId);
            section.classList.toggle('expanded');
            saveExpandedState();
        }

        async function setTeam(userId, slotTime, team) {
            // Save state before reload
            saveExpandedState();
            try {
                const res = await fetch('/api/teams/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messageId, userId, slotTime, team })
                });
                if (res.ok) {
                    location.reload();
                } else {
                    alert('Failed to update team');
                }
            } catch (e) {
                console.error(e);
                alert('Error updating team');
            }
        }
    </script>
</body>

</html>