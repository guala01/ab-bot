<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Teams - <%= day %>
    </title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #121212;
            color: #e0e0e0;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #888;
            text-decoration: none;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: #fff;
        }

        h1 {
            color: #fff;
            margin: 0 0 5px 0;
            font-weight: 600;
        }

        .meta {
            color: #555;
            font-size: 0.85em;
            margin-bottom: 25px;
        }

        .remind-btn {
            background: #0099ff;
            color: #121212;
            border: none;
            padding: 10px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        .remind-btn:hover {
            opacity: 0.85;
        }

        .slot-title .remind-btn {
            margin-left: auto;
            padding: 6px 10px;
            border-radius: 4px;
            font-weight: 600;
        }

        .slot-section {
            margin-bottom: 25px;
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
        }

        .slot-title {
            background: #333;
            color: #fff;
            padding: 6px 14px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 0;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }

        .slot-title:hover {
            background: #3a3a3a;
        }

        .slot-title .arrow {
            transition: transform 0.2s;
            font-size: 0.8em;
        }

        /* Hide slots until JS applies state */
        .slot-section {
            opacity: 0;
            transition: opacity 0.1s;
        }

        body.ready .slot-section {
            opacity: 1;
        }

        .slot-section.expanded .slot-title {
            margin-bottom: 15px;
        }

        .slot-section.expanded .slot-title .arrow {
            transform: rotate(90deg);
        }

        .teams-container {
            display: none;
            gap: 12px;
        }

        .slot-section.expanded .teams-container {
            display: flex;
        }

        .team-col {
            flex: 1;
            background: #252525;
            padding: 12px;
            border-radius: 6px;
            min-height: 120px;
            border: 1px solid #333;
        }

        .team-header {
            font-weight: 600;
            text-align: center;
            margin-bottom: 12px;
            font-size: 0.95em;
            color: #aaa;
        }

        .player-card {
            background: #1e1e1e;
            padding: 10px 12px;
            margin-bottom: 8px;
            border: 1px solid #333;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: border-color 0.2s;
        }

        .player-card:hover {
            border-color: #555;
        }

        .player-name {
            font-weight: 500;
        }

        .player-username {
            font-size: 0.8em;
            color: #555;
        }

        .actions {
            display: flex;
            gap: 4px;
        }

        .actions button {
            font-size: 0.75em;
            padding: 4px 8px;
            cursor: pointer;
            border: none;
            border-radius: 3px;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        .btn-a {
            background: #ffa726;
            color: #121212;
        }

        .btn-b {
            background: #66bb6a;
            color: #121212;
        }

        .btn-u {
            background: #555;
            color: #fff;
        }

        .actions button:hover {
            opacity: 0.8;
        }

        .empty-slot {
            color: #555;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="/dashboard" class="back-link">‚Üê Back to Dashboard</a>
        <h1>Manage Teams: <%= day %>
        </h1>
        <div class="meta">Message IDs: <%= messageId %>
        </div>

        <% // Custom sort: treat 00:00-05:59 as "after 24:00" for proper ordering const
            times=Object.keys(slots).sort((a, b)=> {
            const hourA = parseInt(a.split(':')[0]);
            const hourB = parseInt(b.split(':')[0]);
            const adjA = hourA < 6 ? hourA + 24 : hourA; const adjB=hourB < 6 ? hourB + 24 : hourB; if (adjA !==adjB)
                return adjA - adjB; return a.localeCompare(b); }); %>
                <% if (times.length===0) { %>
                    <div class="empty-slot">No signups for this day.</div>
                    <% } %>

                        <% times.forEach(function(time) { %>
                            <% const total=slots[time].length; const countA=slots[time].filter(s=> s.team ===
                                'A').length;
                                const countB = slots[time].filter(s => s.team === 'B').length;
                                const countU = total - countA - countB;
                                %>
                                <div class="slot-section" id="slot-<%= time.replace(':', '-') %>">
                                    <div class="slot-title" onclick="toggleSlot('<%= time.replace(':', '-') %>')">
                                        <span class="arrow">‚ñ∂</span>
                                        üïê <%= time %> <span style="opacity:0.7;">(<%= total %>)</span>
                                        <button class="remind-btn" onclick="event.stopPropagation(); sendTeamReminders('<%= time %>')">Remind</button>
                                    </div>
                                    <div class="teams-container">
                                        <!-- Unassigned -->
                                        <div class="team-col">
                                            <div class="team-header">Unassigned (<%= countU %>)</div>
                                            <% let hasUnassigned=false; %>
                                                <% slots[time].forEach(function(s) { if (!s.team) { hasUnassigned=true;
                                                    %>
                                                    <div class="player-card">
                                                        <div>
                                                            <div class="player-name">
                                                                <%= s.customName || s.user_display_name %>
                                                            </div>
                                                            <div class="player-username">
                                                                <%= s.username %>
                                                            </div>
                                                        </div>
                                                            <div class="actions">
                                                            <button class="btn-a"
                                                                onclick="setTeam('<%= s.message_id %>', '<%= s.user_id %>', '<%= time %>', 'A')">A</button>
                                                            <button class="btn-b"
                                                                onclick="setTeam('<%= s.message_id %>', '<%= s.user_id %>', '<%= time %>', 'B')">B</button>
                                                        </div>
                                                    </div>
                                                    <% } }); %>
                                                        <% if (!hasUnassigned) { %>
                                                            <div class="empty-slot">‚Äî</div>
                                                            <% } %>
                                        </div>

                                        <!-- Team A -->
                                        <div class="team-col">
                                            <div class="team-header" style="color:#ffa726;">Team A (<%= countA %>)</div>
                                            <% let hasA=false; %>
                                                <% slots[time].forEach(function(s) { if (s.team==='A' ) { hasA=true; %>
                                                    <div class="player-card">
                                                        <div class="player-name">
                                                            <%= s.customName || s.user_display_name %>
                                                        </div>
                                                        <div class="actions">
                                                            <button class="btn-u"
                                                                onclick="setTeam('<%= s.message_id %>', '<%= s.user_id %>', '<%= time %>', null)">‚úï</button>
                                                            <button class="btn-b"
                                                                onclick="setTeam('<%= s.message_id %>', '<%= s.user_id %>', '<%= time %>', 'B')">‚ÜíB</button>
                                                        </div>
                                                    </div>
                                                    <% } }); %>
                                                        <% if (!hasA) { %>
                                                            <div class="empty-slot">‚Äî</div>
                                                            <% } %>
                                        </div>

                                        <!-- Team B -->
                                        <div class="team-col">
                                            <div class="team-header" style="color:#66bb6a;">Team B (<%= countB %>)</div>
                                            <% let hasB=false; %>
                                                <% slots[time].forEach(function(s) { if (s.team==='B' ) { hasB=true; %>
                                                    <div class="player-card">
                                                        <div class="player-name">
                                                            <%= s.customName || s.user_display_name %>
                                                        </div>
                                                        <div class="actions">
                                                            <button class="btn-u"
                                                                onclick="setTeam('<%= s.message_id %>', '<%= s.user_id %>', '<%= time %>', null)">‚úï</button>
                                                            <button class="btn-a"
                                                                onclick="setTeam('<%= s.message_id %>', '<%= s.user_id %>', '<%= time %>', 'A')">‚ÜíA</button>
                                                        </div>
                                                    </div>
                                                    <% } }); %>
                                                        <% if (!hasB) { %>
                                                            <div class="empty-slot">‚Äî</div>
                                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                                <% }); %>
    </div>

    <script>
        const messageIds = <%- JSON.stringify(messageIds || []) %>;
        const messageKey = '<%= messageKey %>';

        // Restore expanded slots from sessionStorage
        document.addEventListener('DOMContentLoaded', () => {
            const expandedSlots = JSON.parse(sessionStorage.getItem('expandedSlots_' + messageKey) || '[]');
            expandedSlots.forEach(slotId => {
                const section = document.getElementById('slot-' + slotId);
                if (section) section.classList.add('expanded');
            });
            // Show slots after state is restored
            document.body.classList.add('ready');
        });

        function saveExpandedState() {
            const expanded = [];
            document.querySelectorAll('.slot-section.expanded').forEach(el => {
                expanded.push(el.id.replace('slot-', ''));
            });
            sessionStorage.setItem('expandedSlots_' + messageKey, JSON.stringify(expanded));
        }

        function toggleSlot(slotId) {
            const section = document.getElementById('slot-' + slotId);
            section.classList.toggle('expanded');
            saveExpandedState();
        }

        async function setTeam(messageId, userId, slotTime, team) {
            // Save state before reload
            saveExpandedState();
            try {
                const res = await fetch('/api/teams/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messageId, userId, slotTime, team })
                });
                if (res.ok) {
                    location.reload();
                } else {
                    alert('Failed to update team');
                }
            } catch (e) {
                console.error(e);
                alert('Error updating team');
            }
        }

        async function sendTeamReminders(slotTime) {
            if (!Array.isArray(messageIds) || messageIds.length === 0) return;
            if (typeof slotTime !== 'string' || slotTime.length === 0) return;
            const ok = confirm(`Send reminder pings for ${slotTime}?`);
            if (!ok) return;
            try {
                const res = await fetch('/api/remind-teams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messageIds, slotTime })
                });
                const data = await res.json().catch(() => null);
                if (!res.ok) {
                    alert(data && data.error ? data.error : 'Failed to send reminders');
                    return;
                }
                const lines = [];
                lines.push(`Sent ${data.sent || 0} message(s).`);
                if (typeof data.attempted === 'number') lines.push(`Matches processed: ${data.attempted}`);
                if (Array.isArray(data.details) && data.details.length > 0) {
                    data.details.forEach(d => {
                        if (!d) return;
                        const bFlag = d.pingedB ? 'pinged' : 'not pinged';
                        const aInfo = `A sent ${d.sentMessagesA || 0}/${d.plannedMessagesA || 0}`;
                        const bInfo = `B sent ${d.sentMessagesB || 0}/${d.plannedMessagesB || 0}`;
                        lines.push(`${d.slotTime} ‚Äî A:${d.teamA} B:${d.teamB} (B ${bFlag}) ‚Äî ${aInfo}, ${bInfo}`);
                    });
                }
                if (Array.isArray(data.skippedMessageIds) && data.skippedMessageIds.length > 0) {
                    lines.push(`Skipped message IDs (missing metadata): ${data.skippedMessageIds.join(', ')}`);
                }
                if (Array.isArray(data.usedFallbackForMessageIds) && data.usedFallbackForMessageIds.length > 0) {
                    lines.push(`Used fallback channel for: ${data.usedFallbackForMessageIds.join(', ')}`);
                }
                if (Array.isArray(data.errors) && data.errors.length > 0) {
                    lines.push(`Errors: ${data.errors.map(e => (e && e.error) ? e.error : 'Unknown').join(' | ')}`);
                }
                alert(lines.join('\n'));
            } catch (e) {
                console.error(e);
                alert('Failed to send reminders');
            }
        }
    </script>
</body>

</html>
